<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="theme-color" content="#000000">

        <link rel="stylesheet" href="/styles/main.css">
        <link rel="stylesheet" href="element.css">
        <script src="vue.global.prod.js"></script>
        <script src="element-plus.js"></script>
        <script src="axios.min.js"></script>
        <script src="qs.min.js"></script>
        <title>图片标注工具</title>
    </head>

    <body>
        <noscript>
            You need to enable JavaScript to run this app.
        </noscript>


        <div id="ls-container" class="ls-container">
            <div class="image-container">
                <img style="margin-top: 20px;" @click="onImageClick(item,index)" v-for="(item, index) in tasks"
                    :key="index" :src="item.data.image" class="left-pannel-img" />
            </div>


            <div id="label-studio" class="label-studio">
            </div>

            <!-- <div style="position: fixed;bottom: 0px;right:0px;z-index: 200;margin: 0 10px 80px 0;">
                <div>
                    <el-input style="width: 300px;" :rows="3" v-model="opinion" type="textarea" placeholder="请输入诊断建议">
                    </el-input>
                </div>
                <el-button style="width: 300px;margin-top:20px" type="primary" :loading="submitLoading"
                    @click="dialogVisible=true">提交</el-button>
            </div> -->

            <el-dialog v-model="dialogVisible" title="请填写标注进度和诊断建议" :width="400"
                @closed="form.progress=1;form.opinion=''">

                <el-form :model="form" :label-width="100">
                    <el-form-item label="进度：">
                        <el-input-number style="width:240px;" v-model="form.progress" :min="1" :max="100"
                            controls-position="right"></el-input-number>
                    </el-form-item>
                    <el-form-item label="诊断建议：">
                        <el-input style="width: 240px;" :rows="3" v-model="form.opinion" type="textarea"
                            placeholder="请输入诊断建议">
                        </el-input>
                    </el-form-item>
                </el-form>
                <template #footer>
                    <span class="dialog-footer">
                        <el-button @click="dialogVisible = false">取消</el-button>
                        <el-button type="primary" :loading="submitLoading" @click="submitAnotations()">
                            确认
                        </el-button>
                    </span>
                </template>
            </el-dialog>
        </div>
        <style>
            body {
                height: 100vh;
            }

            .ls-container {
                display: flex;
            }

            .image-container {
                width: 180px;
                height: 100vh;
                box-sizing: border-box;
                overflow-y: auto;
                overflow-x: hidden;
            }

            .label-studio {
                height: calc(100vh - 88px);
                width: calc(100% - 180px) !important;
            }

            .left-pannel-img {
                height: 140px;
                width: 140px;
                margin: 20px;
            }
        </style>
        <script>

            //引入qs
            const qs = Qs;
            //使用axios
            const service = axios.create({
                baseURL: '',
                timeout: 10000 * 5,
                headers: {
                    //公共请求头配置，本项目请求头大多数接口是这个，所以这里可以配置一下，对于特殊接口单独配置
                    "Content-Type": "application/json;charset=UTF-8"
                }
            });
            // request拦截器
            service.interceptors.request.use(
                config => {
                    config.headers['Authorization'] = window.token;
                    if (config.method === 'get') {
                        config.paramsSerializer = function (params) {
                            return qs.stringify(params, { arrayFormat: 'indices' });
                        };
                    }
                    return config
                },
                error => {
                    console.log(error)
                    Promise.reject(error)
                }
            )

            const processErrorResponse = (response) => {
                return Promise.reject(response.data);
            }

            /* 响应拦截器 */
            service.interceptors.response.use((res) => {
                // 请求成功，token自动续期
                //B3105 接口没有做短信校验  C1004
                if (res.data.code === '00000' || res.data.code === 'A1007' || res.data.code === 'C1004' || res.data.code === 'B3105') {
                    return res;
                }
                // 处理响应错误，请求异常自动提示错误信息，如果是B0301就跳转到登录界面
                return processErrorResponse(res);
            }, (error) => {
                // 处理响应错误
                return processErrorResponse(error.response);
            });

            const { createApp } = Vue;
            const { ElMessage } = ElementPlus;
            var labels = [
                {
                    name: "肺结节标签1",
                    color: 'red'
                },
                {
                    name: "肺结节标签2",
                    color: 'blue'
                }
            ];
            var templateLabels = [];
            labels.forEach((x, index) => {
                //selected 设置底部标签默认选中状态
                if (index == 0) {
                    templateLabels.push(`<label name="${x.name}" value="${x.name}" selected="true"  background="${x.color}"></label>`)
                } else {
                    templateLabels.push(`<label name="${x.name}" value="${x.name}"  background="${x.color}"></label>`)
                }
            });
            var options = {
                interfaces: [
                    // "panel",
                    "update",
                    "submit",
                    // "skip",
                    "controls",
                    // "review",
                    // "infobar",
                    "topbar",
                    "instruction",
                    // "side-column",
                    // "ground-truth",
                    "annotations:tabs",
                    "annotations:menu",
                    "annotations:history",
                    "annotations:current",
                    // "annotations:comments"
                    // "annotations:add-new",
                    // "annotations:delete",
                    // 'annotations:view-all',
                    // "predictions:tabs",
                    // "predictions:menu",
                    // "auto-annotation",
                    // "edit-history",
                    // "topbar:prevnext",
                ],
                config: `
                    <View>
                        <Ellipse name="ellipse1-1" toName="image" />
                        <Image name="image" value="$image" />
                        <Rectangle name="rect-1" toName="image" />
                        <Polygon name="rect-2" toName="image" />
                        <labels  name="lbl" toName="image">
                          ${templateLabels}
                        </labels>
                    </View>`,
                task: null,
                description: ''
            }


            const app = createApp({
                data() {
                    return {
                        ls: "",
                        dialogVisible: false,
                        submitLoading: false,
                        labels: labels,
                        imageIndex: 0,
                        selectAnnotationIndex: 0,
                        tasks: [],
                        form: {
                            progress: 1,
                            opinion: '',
                        }
                    }
                },
                methods: {
                    onImageClick(item, index) {
                        if (!this.ls) {
                            return;
                        }
                        if (this.imageIndex != index) {
                            this.setCurrentTaskData();
                            this.imageIndex = index
                            this.selectAnnotationIndex = 0;
                            this.ls.destroy();
                            this.initData();
                        }
                    },
                    setCurrentTaskData() {
                        //获取所有的标签数据
                        let annotations = this.ls.store.annotationStore.annotations;
                        let cacheResults = [];
                        annotations.forEach(annotation => {
                            let result = annotation.serializeAnnotation()
                            cacheResults = cacheResults.concat(result);
                        });
                        this.tasks[this.imageIndex].annotations[this.selectAnnotationIndex].result = cacheResults;
                    },
                    getLabelDataFromServer() {
                        let postData = {
                            taskId: this.getUrlParamFromUrl("taskId"),
                            dataId: this.getUrlParamFromUrl("dataId"),
                            processType: this.getUrlParamFromUrl("processType"),
                        }
                        service.get("http://localhost:8080/api/annotation-service/annotation/task/image/data", { params: postData }).then((rsp => {
                            this.submitLoading = false;
                            if (rsp.status == 200 && rsp.data.success) {
                                let labelDataStr = rsp.data.data.annotationData;
                                if (labelDataStr) {
                                    let labelData = JSON.parse(labelDataStr);
                                    let tasks = labelData.tasks;
                                    console.log("originTask", tasks);
                                    let userId = this.getUrlParamFromUrl("userId");
                                    tasks.forEach(x => {
                                        console.log(x.annotations.length);
                                        if (x.annotations && x.annotations.length == 0) {
                                            x.annotations = [{ id: userId, result: [] }]
                                        } else {
                                            x.annotations.forEach(y => {
                                                if (y.result && y.result == 0) {
                                                    x.annotations = [{ id: userId, result: [] }]
                                                }
                                            })
                                        }
                                    });
                                    this.tasks = tasks;
                                    console.log("totalTask", tasks);
                                    this.initData();
                                }
                            }
                        })).catch((error) => {
                            console.log(error);
                            ElMessage({
                                showClose: true,
                                message: error && error.message ? error.message : "请求错误请重试",
                                type: 'error',
                            })
                            this.tasks = [
                                {
                                    id: 1,
                                    data: {
                                        image: "https://htx-misc.s3.amazonaws.com/opensource/label-studio/examples/images/nick-owuor-astro-nic-visuals-wDifg5xc9Z4-unsplash.jpg",
                                    },
                                    annotations: [
                                        {
                                            id: '1001',
                                            createdBy: '邓宏',
                                            result: [
                                                {
                                                    id: 'Dx_aB91ISN',
                                                    source: '$image',
                                                    from_name: 'lbl',
                                                    to_name: 'image',
                                                    type: 'labels',
                                                    origin: 'manual',
                                                    value: {
                                                        height: 10.458911419423693,
                                                        width: 12.4,
                                                        x: 80,
                                                        y: 80,
                                                        labels: [
                                                            "肺结节标签2"
                                                        ],
                                                    },
                                                },
                                            ]
                                        },
                                        {
                                            id: '1002',
                                            createdBy: '子群',
                                            result: [
                                                {
                                                    id: 'Dx_aB91ISN',
                                                    source: '$image',
                                                    from_name: 'lbl',
                                                    to_name: 'image',
                                                    type: 'labels',
                                                    origin: 'manual',
                                                    value: {
                                                        height: 10.458911419423693,
                                                        width: 12.4,
                                                        x: 80,
                                                        y: 80,
                                                        labels: [
                                                            "肺结节标签2"
                                                        ],
                                                    },
                                                },
                                            ]
                                        },
                                    ],
                                }
                            ]
                            this.initData();
                        })
                    },
                    submitAnotations() {
                        this.submitLoading = true;
                        this.setCurrentTaskData();
                        let postData = {
                            taskId: this.getUrlParamFromUrl("taskId"),
                            dataId: this.getUrlParamFromUrl("dataId"),
                            processType: this.getUrlParamFromUrl("processType"),
                            opinion: this.form.opinion,
                            progress: this.form.progress,
                            annotationData: JSON.stringify({
                                tasks: this.tasks,
                            })
                        }
                        service.post("http://localhost:8080/api/annotation-service/annotation/task/data/commit", postData).then((rsp => {
                            this.submitLoading = false;
                            if (rsp.status == 200 && rsp.data.success) {
                                this.dialogVisible = false;
                                ElMessage({
                                    showClose: true,
                                    message: "标注数据提交成功",
                                    type: 'success',
                                })
                            }
                        })).catch((error) => {
                            this.submitLoading = false;
                            ElMessage({
                                showClose: true,
                                message: error && error.message ? error.message : "请求错误请重试",
                                type: 'error',
                            })
                        })
                    },
                    initData() {
                        options.task = this.tasks[this.imageIndex];
                        this.ls = new LabelStudio("label-studio", options);
                        this.ls.on("storageInitialized", (store) => {
                            this.ls.on("selectAnnotation", (next) => {
                                //当地选中的anotation
                                this.selectAnnotationIndex = this.tasks[this.imageIndex].annotations.findIndex(x.id == next.pk);
                            })

                            // this.ls.on("regionFinishedDrawing", (region, list) => {
                            //     console.log("finish drawing", region)
                            // })

                        })

                        this.ls.on("updateAnnotation", (LS, annotation) => {
                            this.dialogVisible = true;
                        });
                    },
                    getUrlParamFromUrl(key) {
                        let result = "";
                        let url = window.location.href;
                        let urlParams = url.split('?');
                        if (urlParams.length > 1) {
                            let params = urlParams[1];
                            let paramsArr = params.split('&');
                            paramsArr.forEach(item => {
                                if (item.includes(key)) result = item.split('=')[1];
                            });
                        }
                        return result;
                    }
                },
                mounted() {
                    window.token = this.getUrlParamFromUrl("token");
                    document.addEventListener('DOMContentLoaded', (e) => {
                        this.getLabelDataFromServer();
                    })
                },
            });
            app.use(ElementPlus).mount("#ls-container");
        </script>
    </body>

</html>